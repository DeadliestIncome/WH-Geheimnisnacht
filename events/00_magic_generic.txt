##############################################
#
# @author Pietrko <p.l.stepnicki@gmail.com>
# @description Spell engine events
# @version 1.3.0
# @wip
# @compatibility 2.8.x
#
# 1 - cooldown event
# 3-9 - miscast events followups
#
#
# Battle spell thing
# 11 - battle casting
# 12 - battle miscast
#
##############################################
namespace = magic_generic
##############################################


# Resetting magic state
character_event = {
	id = magic_generic.1
	is_triggered_only = yes
	hide_window = yes
	immediate = {
		if = {
			limit = {
				OR = {
					trait = magic_potential_1
					trait = magic_potential_2
				}
			}
			clr_magic_state = yes
			calc_magic_power_effect = yes
		}
	}
}
# Spell failure event  (no consequences)
character_event = {
	id = magic_generic.2
	desc = "magic_generic.2_desc"
	is_triggered_only = yes
	picture = "GFX_evt_miscast"
	option = { name = OK }
}

# Spell miscast dispatcher (consequences)
#1. miscast_wound
#2. miscast_maim
#3. miscast_death
#4. miscast_mental_block
#5. miscast_unnatural_aura
#6. miscast_possession
#7. miscast_incapable
#8. miscast_health
#9. miscast_mutation
#10. miscast_enfeeblement 

# Miscast reporting event
character_event = {
	id = magic_generic.3
	title = magic_generic.3_title
	# Baad
	desc = {
		text = "miscast_maim_desc"
		trigger = { has_character_flag = miscast_maim }
	}
	desc = {
		text = "miscast_death_desc"
		trigger = { has_character_flag = miscast_death }
	}
	desc = {
		text = "miscast_incapable_desc"
		trigger = { has_character_flag = miscast_incapable }
	}
	# Major
	desc = {
		text = "miscast_mutation_desc"
		trigger = { has_character_flag = miscast_mutation }
	}
	desc = {
		text = "miscast_possesion_desc"
		trigger = { has_character_flag = miscast_possession }
	}
	desc = {
		text = "miscast_health_desc"
		trigger = { has_character_flag = miscast_health }
	}
	desc = {
		text = "miscast_vision_desc"
		trigger = { has_character_flag = miscast_vision }
	}
	# Minor
	desc = {
		text = "miscast_unnatural_aura_desc"
		trigger = { has_character_flag = miscast_unnatural_aura }
	}
	desc = {
		text = "miscast_mental_block_desc"
		trigger = { has_character_flag = miscast_mental_block }
	}
	desc = {
		text = "miscast_wound_desc"
		trigger = { has_character_flag = miscast_wound }
	}

	is_triggered_only = yes
	picture = "GFX_evt_miscast"
   
   	# Apply effects
	immediate = {
		miscast_roll_effect = yes
		miscast_apply_effect = yes
	}
	option = {
		name = CURSES
		tooltip = { miscast_apply_effect = yes }	
	}
}
	
################################################################
#
# BATTLE SPELL ENGINE
#
# on_combat_start: Common army based spells triggering
# on_combat_pulse: magic_generic.11 - recurring
# on_combat_pulse: magic_generic.14
#
################################################################

# Event chain: Character targeted battlespell, 2
character_event = {
	id = magic_generic.11
	hide_window = yes
	is_triggered_only = yes
	capable_only = yes

	trigger = {
		# TODO Take into consideration magic power going to zero 
		# Due to special effects
		is_battle_caster_trigger = yes
		is_alive = yes
	}

	weight_multiplier = { days = 1 }
	
	immediate = {
		save_event_target_as = magic_caster
		location = { save_event_target_as = magic_location }
		
		# Dispatch spells
		if = {
			limit = { trait = lore_ice }
			character_event = { id = "ice_lore.0" }
		}
		else_if = {
			limit = { trait = lore_necromancy }
			character_event = { id = "necromancy_lore.0" }
		}
		# If there's no known lore some casters still know a few
		#spells
		else_if = {
			limit = { 
				OR = {
					trait = lore_chaos 
					trait = lore_slaanesh
					trait = lore_nurgle
					trait = lore_tzeentch
				}
			}
			character_event = { id = "chaos_lore.0" }
		}
	}
}
# on_combat_pulse: Battle miscast
character_event = {
	id = magic_generic.12
	title = magic_generic.12_title
	picture = GFX_evt_miscast
	desc = magic_generic.12_desc
	is_triggered_only = yes

	trigger = {
		NOT = { has_character_flag = magic_cooldown }
		NOT = { has_character_flag = last_spell_success }
		NOT = { has_character_flag = last_spell_failure }
		is_battle_caster_trigger = yes
		is_alive = yes
	}

	weight_multiplier = { 
		days = 1 
		# Place based modifiers
		modifier = {
			factor = 0.9
			learning = 10
		}
		modifier = {
			factor = 0.9
			learning = 13
		}
		modifier = {
			factor = 0.9
			learning = 16
		}
		modifier = {
			factor = 0.9
			learning = 19
		}
		modifier = {
			factor = 0.9
			learning = 21
		}
		modifier = {
			factor = 0.9
			learning = 24
		}
		modifier = {
			factor = 0.9
			learning = 27
		}
		modifier = {
			factor = 0.9
			learning = 30
		}
		modifier = {
			factor = 0.9
			trait = patient
		}
		modifier = {
			factor = 2
			trait = possessed
		}
		modifier = {
			factor = 1.1
			trait = wroth
		}
		modifier = {
			factor = 1.3
			trait = wounded
		}
		modifier = {
			factor = 1.3
			trait = stressed
		}
		modifier = {
			factor = 1.1
			is_weak_trigger = yes
		}
		modifier = {
			factor = 2.0
			OR = {
				trait = dull
				trait = slow
			}
		}
		# Negative
		modifier = {
			factor = 2.0
			trait = hedge_wizard
		}
		modifier = {
			factor = 1.4
			OR = {
				trait = warlock
				trait = bray_shaman
				trait = witch
				trait = mage_apprentice
			}
		}
		modifier = {
			factor = 1.4
			OR = {
				# Dark magic is unsafe
				trait = lore_dark_magic
				trait = lore_slaanesh
				trait = lore_tzeentch
				trait = lore_nurgle
				trait = lore_necromancy
			}
		}
		modifier = {
			factor = 1.2
			check_variable = { which = "magic_power" value = 3 }
		}
		modifier = {
			factor = 1.2
			check_variable = { which = "magic_power" value = 4 }
		}
		modifier = {
			factor = 1.2
			check_variable = { which = "magic_power" value = 5 }
		}
		# CASTER TRAITS and miscast chance
		# Special mages - they are more disciplined than others
		modifier = {
			factor = 0.7
			OR = {
				trait = ice_witch
				trait = druchi_mage
				trait = druchi_sorceress
				trait = asrai_spellsinger
			}
		}
		# Hardest to corrupt 
		modifier = {
			factor = 0.9
			trait = lore_light
		}
		# Asur mages are disciplined - they do not feed chaos
		modifier = {
			factor = 0.5
			OR = {
				trait = asur_mage
				trait = skink_priest
			}
		}
		modifier = {
			factor = 0.33
			trait = creature_slann
		}
	}
   
   	# Apply effects
	immediate = {
		miscast_roll_effect = yes
		miscast_apply_effect = yes
	}
	option = {
		name = CURSES
		tooltip = { miscast_apply_effect = yes }	
	}
}

# Clear magic state: on end battle
character_event = {
	#FXIME
	id = magic_generic.20
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		is_battle_caster_trigger = yes
		is_alive = yes
	}
	immediate = {
		clr_spell_flags_effect = yes
		clr_magic_state = yes
	}
}
