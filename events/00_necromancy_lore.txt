namespace = necromancy_lore

# Battle spell picking for necromancy
character_event = {
	id = necromancy_lore.0
	is_triggered_only = yes
	hide_window = yes

	immediate = {
		calc_magic_power_effect = yes 
		battle_magic_test_effect = yes
		# Select enemy target
		target_enemy_unit_owner_effect = yes
		# Select spell composition
		while = {
			limit = {
				check_variable = { which = "battle_casting_roll" value = 3.5 }
			}
			# Raise dead base cost 22 magic points 
			# can be scaled to animate dead that cost 5.5
			random_list = {
				25 = {
					change_variable = { 
						which = "battle_casting_roll" 
						value = -5.5
					}
					change_variable = {
						which = "magic_summon_undead" 
						value = 1
					}
					set_character_flag = cast_raise_dead 
				}
				# Hex
				25 = {
					modifier = {
						factor = 0
						has_character_flag = cast_call_of_vanhell
					}
					modifier = {
						factor = 0 
						NOT = {
							check_variable = { 
								which = "battle_casting_roll" 
								value =	15
							}
						}
					}
					modifier = {
						factor = 0
						any_controlled_unit = {
							location = { province = event_target:magic_location }
							center_flank_leader = {
								combat = { 
									flank_has_tactic = call_of_vanhel_tactic
								}
								character = ROOT
							}
							right_flank_leader = {
								combat = { 
									flank_has_tactic = call_of_vanhel_tactic
								}
								character = ROOT
							}
							left_flank_leader = {
								combat = { 
									flank_has_tactic = call_of_vanhel_tactic
								}
								character = ROOT
							}
						}
					}
					change_variable = { 
						which = "battle_casting_roll" 
						value = -15
					}
					set_character_flag = cast_call_of_vanhell
				}
				# Curse of years
				25 = {
					modifier = {
						factor = 0
						always = yes
					}
					modifier = {
						factor = 0
						has_character_flag = cast_curse_of_years
					}
					modifier = {
						factor = 0 
						NOT = {
							check_variable = { 
								which = "battle_casting_roll" 
								value =	18
							}
						}
					}
					change_variable = { 
						which = "battle_casting_roll" 
						value = -18
					}
					# Flat dmg + morale dmg
					change_variable = { 
						which = "magic_morale_dmg" 
						value = 2
					}
					change_variable = { 
						which = "magic_dmg_flat" 
						value = 1
					}
					set_character_flag = cast_curse_of_years
				}
				# With of death (costs 21, can be scaled, but has minimum)
				25 = {
					modifier = {
						factor = 0
						has_character_flag = cast_wind_of_death
					}
					modifier = {
						factor = 0
						NOT = { 
							check_variable = { 
								which = "battle_casting_roll" 
								value =	23
							}
						}
					}
					change_variable = { 
						which = "battle_casting_roll" 
						value = -23
					}
					# TODO change it to affect weak units
					change_variable = { which = "magic_dmg_percent" value = 2 }
					change_variable = { which = "magic_dmg_flat" value = 1 }
					set_character_flag = cast_wind_of_death
				}
			}
		}
		# Reporting event
		if = {
			limit = {
				OR = {
					has_character_flag = cast_curse_of_years
					has_character_flag = cast_call_of_vanhel
					has_character_flag = cast_raise_dead
					has_character_flag = cast_wind_of_death
				}
			}
			character_event = { id = necromancy_lore.1 }
		}
		else = {
			hidden_tooltip = {
				clr_magic_state = yes
				clr_spell_flags_effect = yes
			}
		}
	}
}

# Necormancy lore spells are in fact a mixture of two lores:
# Dark Lore of Vampires (that is lore of Nagash)
# Dark Lore of Necormancy (common one)
#
#
# Dead raised in battle
# Raise dead (both vampires and common necromancy)

character_event = {
	id = necromancy_lore.1
	title = necromancy_cast_title
	border = GFX_event_normal_frame_war
	desc = {
		# Raise dead
		trigger = { has_character_flag = cast_raise_dead }
		text = necromancy_lore.10_desc
		picture = GFX_evt_zombies
	}
	desc = {
		# Call of Vanhel
		trigger = { has_character_flag = cast_call_of_vanhel }
		text = necromancy_lore.20_desc
		picture = GFX_evt_zombies
	}
	desc = {
		# Curse of years
		trigger = { has_character_flag = cast_curse_of_years }
		text = necromancy_lore.30_desc
		picture = GFX_evt_mage_lore_necromancy
	}
	desc = {
		# Wind of Death
		trigger = { has_character_flag = cast_wind_of_death }
		text = necromancy_lore.40_desc
		picture = GFX_evt_mage_lore_necromancy
	}
	is_triggered_only = yes
	picture = GFX_evt_mage_lore_necromancy

	option = {
		name = necromancy_cast_desc
		#miscast_apply_effect = yes
		# Raise dead
		if = {
			limit = { has_character_flag = cast_raise_dead }
			magic_raise_dead_effect = yes
		}
		# Wind of Death & 
		event_target:magic_target_unit_owner = {
			random_controlled_unit = {
				limit = { location = { province = event_target:magic_location }}
				# Army dmg effect (percent dmg)
				magic_dmg_precent_effect = yes 
				magic_morale_dmg_effect = yes 
				magic_dmg_flat_effect = yes 
			}
		}
		# Call of Vanhel tactics effect
		if = {
			limit = { has_character_flag = cast_call_of_vanhel }
			any_controlled_unit = {
				limit = { location = { province = event_target:magic_location }}
				center_flank_leader = {
					if = {
						limit = { character = ROOT }
						combat = { set_flank_tactic = call_of_vanhel_tactic }
					}
				}
				left_flank_leader = {
					if = {
						limit = { character = ROOT }
						combat = { set_flank_tactic = call_of_vanhel_tactic }
					}
				}
				right_flank_leader = {
					if = {
						limit = { character = ROOT }
						combat = { set_flank_tactic = call_of_vanhel_tactic }
					}
				}
			}
		}
	}
	after = {
		hidden_tooltip = {
			clr_magic_state = yes
			clr_spell_flags_effect = yes
		}
	}
}
