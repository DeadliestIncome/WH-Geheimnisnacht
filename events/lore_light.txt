namespace = lore_light

# Battle spell Pha's protection
# Assigns defence + 20% defence trait
# Characer has to be in battle to perform it
character_event = {
	id = lore_light.100
	title = lore_light_title.100
	desc = lore_light_desc.100#"Your power consumes the life of your chosen target "
	is_triggered_only = yes
	picture = GFX_evt_mage_lore_light

	immediate = {
		location = { save_event_target_as = magic_location }
		random_army = {
			limit = {
				location = { province = event_target:magic_location }
				unit_is_in_combat = yes
				OR = {
					center_flank_leader = { character = ROOT }
					left_flank_leader = { character = ROOT }
					right_flank_leader = { character = ROOT }
					leader = { character = ROOT }
				}
			}
			random_list = {
				34 = {
					center_flank_leader = { 
						save_event_target_as = magic_target
					}
				}
				33 = {
					left_flank_leader = { 
						save_event_target_as = magic_target
					}
				}
				33 = {
					right_flank_leader = { 
						save_event_target_as = magic_target
					}
				}
			}
			if = {
				limit = { 
					NOT = {
						event_target:magic_target = { always = yes }
					}
				}
				ROOT = { save_event_target_as = magic_target }
			}
		}
	}
	option = {
		name = lore_light_opta.100
		event_target:magic_target = {
			custom_tooltip = {
				text = lore_light_tooltip.100
				hidden_tooltip = {
					add_trait = spell_phas_protection
					character_event = { id = lore_light.101 days = 4 }
				}
			}
		}
	}
}

# Shem's burning Gaze
# Local damage chance to kill characters
character_event = {
	id = lore_light.200
	title = lore_light_title.200
	desc = lore_light_desc.200
	is_triggered_only = yes
	picture = GFX_evt_mage_lore_light

	immediate = {
		location = { save_event_target_as = magic_location }
		ROOT = { save_event_target_as = magic_caster }
		target_enemy_unit_owner_effect = yes
	}
	option = {
		name = lore_light_opta.200
		# Setup magic power
		set_variable = { which = "magic_dmg_flat" value = 4 }
		set_variable = { which = "magic_dmg_char" value = 2 }
		event_target:magic_target_secondary = {
			if = {
				limit = {
					OR = {
						is_daemon_trigger = yes
						is_undead_trigger = yes
						is_mutated_trigger = yes
						religion_group = chaos_gods_group
						religion_group = horned_rat_god_group
						culture_group = daemonic_group
					}
				}
				event_target:magic_caster = {
					change_variable = { which = "magic_dmg_flat" value = 4 }
					change_variable = { which = "magic_dmg_char" value = 2 }
				}
			}
			if = { 
				limit = { 
					NOT = { trait = blinded }
					random = 66
				} 
				add_trait = blinded
			}
			magic_dmg_character_effect = yes
		}
		event_target:magic_target = {
			magic_dmg_flat_effect = yes
		}
	}

	option = {
		name = "OLD"
		# Setup magic power
		set_variable = { which = "magic_dmg_char" value = 2 }
		set_variable = { which = "magic_dmg_flat" value = 2 }
		event_target:magic_target = {
			# Double dmg against undead and daemons
			if = {
				limit = {
					OR = {
						is_daemon_trigger = yes
						is_undead_trigger = yes
						is_mutated_trigger = yes
						religion_group = chaos_gods_group
						religion_group = horned_rat_god_group
						culture_group = daemonic_group
					}
				}
				event_target:magic_caster = {
					multiply_variable = { which = "magic_dmg_char" value = 2 }
					multiply_variable = { which = "magic_dmg_flat" value = 2 }
				}
			}
			magic_dmg_character_effect = yes
			if = { 
				limit = { 
					NOT = { trait = blinded }
					random = 66
				} 
				add_trait = blinded
			}
			# Small damage to army
			random_army = {
				limit = { 
					location = { province = event_target:magic_location }
					unit_is_in_combat = yes
				}
				magic_dmg_flat_effect = yes
				magic_dmg_percent_effect = yes
			}
		}
	}
}
# Light of battle
character_event = {
	id = lore_light.300
	title = lore_light_title.300
	desc = lore_light_desc.300
	is_triggered_only = yes
	picture = GFX_evt_mage_lore_light

	immediate = {
		save_event_target_as = magic_caster
		location = { save_event_target_as = magic_location }
	}
	option = {
		name = lore_light_opta.300
		# Setup magic power
		set_variable = { which = "magic_morale_heal" value = 5 }
		# Small moarel boost to army
		random_army = {
			limit = { 
				location = { province = event_target:magic_location }
				OR = {
					center_flank_leader = { character = ROOT }
					left_flank_leader = { character = ROOT }
					right_flank_leader = { character = ROOT }
					leader = { character = ROOT }
				}
			}
			morale_heal_effect = yes
		}
	}
}

# Banishment
character_event = {
	id = lore_light.400
	title = lore_light_title.400
	desc = lore_light_desc.400
	is_triggered_only = yes
	picture = GFX_evt_mage_lore_light

	immediate = {
		location = { save_event_target_as = magic_location }
		save_event_target_as = magic_caster
		# This saves proper magic_target as unit
		# And saves magic_target_secondary
		target_enemy_unit_owner_effect = yes
	}
	option = {
		name = lore_light_opta.400
		# Setup magic power
		set_variable = { which = "magic_dmg_flat" value = 3 }
		set_variable = { which = "magic_dmg_percent" value = 2 }
		event_target:magic_target_secondary = {
			if = {
				limit = {
					OR = {
						is_daemon_trigger = yes
						is_undead_trigger = yes
						is_mutated_trigger = yes
						religion_group = chaos_gods_group
						religion_group = horned_rat_god_group
						culture_group = daemonic_group
					}
				}
				event_target:magic_caster = {
					multiply_variable = { which = "magic_dmg_flat" value = 5 }
					set_variable = { which = "magic_dmg_char" value = 5 }
					set_variable = { which = "magic_dmg_percent" value = 4 }
				}
			}
		}
		event_target:magic_target = {
			magic_dmg_flat_effect = yes
			magic_dmg_percent_effect = yes
		}
	}

	option = {
		name = "OLD"
		# Setup magic power
		set_variable = { which = "magic_dmg_flat" value = 3 }
		set_variable = { which = "magic_dmg_percent" value = 2 }
		event_target:magic_target = {
			# This spell is especiallly targetted at daemons
			if = {
				limit = {
					OR = {
						is_daemon_trigger = yes
						is_undead_trigger = yes
						is_mutated_trigger = yes
						religion_group = chaos_gods_group
						religion_group = horned_rat_god_group
						culture_group = daemonic_group
					}
				}
				event_target:magic_caster = {
					multiply_variable = { which = "magic_dmg_flat" value = 5 }
					set_variable = { which = "magic_dmg_char" value = 5 }
					set_variable = { which = "magic_dmg_percent" value = 4 }
				}
				magic_dmg_character_effect = yes
			}
			# Small damage to army
			random_army = {
				limit = { 
					location = { province = event_target:magic_location }
					unit_is_in_combat = yes
				}
				magic_dmg_flat_effect = yes
				magic_dmg_percent_effect = yes
			}
		}
	}
}

# Light of battle
character_event = {
	id = lore_light.500
	title = lore_light_title.500
	desc = lore_light_desc.500
	is_triggered_only = yes
	picture = GFX_evt_mage_lore_light

	immediate = {
		location = {
			save_event_target_as = magic_location
		}
		clr_character_flag = c_flank
		clr_character_flag = l_flank
		clr_character_flag = r_flank
		clr_character_flag = main_leader
	}
	option = {
		name = "TARGET OWN UNITS IN-BATTLE"
		random_controlled_unit = {
			limit = {
				location = { province = event_target:magic_location }
				OR = {
					center_flank_leader = { character = ROOT }
					left_flank_leader = { character = ROOT }
					right_flank_leader = { character = ROOT }
					leader = { character = ROOT }
				}
			}
			save_event_target_as = magic_target_unit
			center_flank_leader = { set_character_flag = c_flank }
			left_flank_leader = { set_character_flag = l_flank }
			right_flank_leader = { set_character_flag = r_flank }
			leader = { set_character_flag = main_leader }
			damage_unit = { amount = 100 }
		}
	}
	option = {
		name = "TARGETING ALLY UNITS/CHARACTERS IN BATTLE"
	}
	option = {
		name = "TARGETING EVENT: controlled_unit"
		any_realm_character = {
			set_character_flag = is_realm_character
			random_unit = {
				limit = {
					location = { province = event_target:magic_location }
					OR = {
						center_flank_leader = { character = PREVPREV }
						left_flank_leader = { character = PREVPREV }
						right_flank_leader = { character = PREVPREV }
						leader = { character = PREVPREV }
					}
				}
				center_flank_leader = { set_character_flag = c_flank_g }
				left_flank_leader = { set_character_flag = l_flank_g }
				right_flank_leader = { set_character_flag = r_flank_g }
				leader = { set_character_flag = main_leader_g }
				damage_unit = { amount = 100 }
			}
		}
	}
}

# TARGETING TEST
character_event = {
	id = lore_light.999
	title = "TARGETING EVENT"
	desc = "ENEMY TARGETING EVENT"
	is_triggered_only = yes
	picture = GFX_evt_mage_lore_light

	immediate = {
		save_event_target_as = magic_caster
		location = { save_event_target_as = magic_location }
		clr_character_flag = c_flank
		clr_character_flag = l_flank
		clr_character_flag = r_flank
		clr_character_flag = case_1
		clr_character_flag = case_2
		clr_character_flag = case_3
		clr_character_flag = case_4
		clr_character_flag = main_leader
	}
	option = {
		# WORKS in 2 cases
		name = "TARGETING RANDOM HOSTILE UNITS ON PROVINCE"
		# Case 1 - enemy directly controls unit
		random_independent_ruler = {
			limit = { 
				war_with = ROOT 
			}
			set_character_flag = enemy_1
			random_controlled_unit = {
				limit = {
					location = { province = event_target:magic_location }
				}
				save_event_target_as = magic_target_unit
				ROOT = { set_character_flag = case_1 }
				damage_unit = { amount = 100 }
			}
			# If enemy is a commander mark him
			if = {
				limit = { 
					in_command = yes
					at_location = event_target:magic_caster 
				}
				save_event_target_as = magic_target_character
			}
		}
		# Case 2 - No directly owned hostile units, check realm characters
		if = {
			limit = { NOT = { event_target:magic_target_unit = { always = yes }}}
			random_independent_ruler = {
				limit = { 
					any_realm_character = {
						war_with = ROOT
					}
				}
				set_character_flag = enemy_2
				random_realm_character = {
					limit = { war_with = ROOT }
					set_character_flag = enemy_realm_1
					random_controlled_unit = {
						limit = { 
							location = { 
								province = event_target:magic_location 
							}
						}
						save_event_target_as = magic_target_unit
						ROOT = { set_character_flag = case_2 }
						damage_unit = { amount = 100 }
					}
					# If enemy is a commander mark him
					if = {
						limit = { 
							in_command = yes
							at_location = event_target:magic_location
						}
						save_event_target_as = magic_target_character
					}
				}
			}
		}
		# Case 3 - out of realm characters
		if = {
			limit = { NOT = { event_target:magic_target_unit = { always = yes }}}
			any_mercenary_band = {
				limit = { war_with = ROOT }
				holder_scope = {
					random_controlled_unit = {
						limit = { 
							location = { 
								province = event_target:magic_location 
								}
							unit_is_in_combat = yes
						}
						damage_unit = { amount = 100 }
						save_event_target_as = magic_target_unit
						ROOT = { set_character_flag = case_3 }
					}
					# If enemy is a commander mark him
					if = {
						limit = { 
							in_command = yes
							at_location = event_target:magic_location
						}
						save_event_target_as = magic_target_character
					}
				}
			}
		}
		if = {
			limit = { NOT = { event_target:magic_target_unit = { always = yes }}}
			ROOT = { set_character_flag = case_4 }
		}
		# Case 4 empty - no character's whatsoever
		event_target:magic_target_unit = {
			center_flank_leader = { set_character_flag = c_flank }
			left_flank_leader = { set_character_flag = l_flank }
			right_flank_leader = { set_character_flag = r_flank }
			leader = { set_character_flag = main_leader }
			damage_unit = { amount = 100 }
		}
		event_target:magic_target_character = {
			set_character_flag = unit_controller
		}
	}
}
