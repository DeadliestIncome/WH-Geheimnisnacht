namespace = kislev

# The son of a ruler volunteers to join the Gryphon Legion
character_event = {
	id = kislev.0
	desc = EVTDESC_KISLEV_0
	picture = GFX_evt_kislev_lancers
	
	only_men = yes
	min_age = 16
	max_age = 45
	only_capable = yes
	prisoner = no
	religion = kislev_gods
	
	trigger = {
		is_ruler = no
		culture_group = kislevite_group
		OR = {
			religion = kislev_gods
			religion = northern_gods
		}
		is_heretic = no
		martial = 5
		is_title_active = d_gryphon_legion
		
		OR = {
			father_even_if_dead = {
				primary_title = { higher_tier_than = BARON }
			}
			mother_even_if_dead = {
				primary_title = { higher_tier_than = BARON }
			}
		}
		
		liege = {
			mercenary =  no
			liege = {
				mercenary = no
			}
		}
		
		has_dlc = "Sons of Abraham"
		
		NOT = {
			any_spouse = {
				is_pregnant = yes
				father_of_unborn = { character = ROOT } # Won't happen if spouse is pregnant with non-bastard child
			}
		}
	}
	
	mean_time_to_happen = {
		years = 120
		modifier = {
			factor = 0.5
			OR = { 
				culture = gospodar
				culture = kislevite
			}
		}
		modifier = {
			factor = 2.0
			learning = 11
		}
		modifier = {
			factor = 0.7
			trait = homosexual
		}
		modifier = {
			factor = 0.75
			NOT = { age = 25 }
		}
		modifier = {
			factor = 1.5
			trait = slothful
		}
		modifier = {
			factor = 2.0
			trait = lustful
		}
		modifier = {
			factor = 2.0
			trait = cynical
		}
		modifier = {
			factor = 2.0
			trait = hedonist
		}
		modifier = {
			factor = 2.0
			trait = craven
		}
		modifier = {
			factor = 0.8
			trait = strong
		}
		modifier = {
			factor = 2.0
			any_heir_title = {
				always = yes
			}
		}
		modifier = {
			factor = 2.0
			is_primary_heir = yes
		}
		modifier = {
			factor = 2
			any_spouse = {
				reverse_opinion = { who = ROOT value = 100 }
			}
		}
	}
	
	option = {
		name = EVTOPTA_KISLEV_0 # Ask to go
		ai_chance = {
			factor = 100
		}
		liege = {
			character_event = {
				id = kislev.1
			}
		}
	}
	option = {
		name = EVTOPTB_KISLEV_0 # It's a bad idea
	}
}

# Son or brother asks to join the Gryphon Legion
character_event = {
	id = kislev.1
	desc = EVTDESC_KISLEV_1
	picture = GFX_evt_kislev_lancers
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_KISLEV_1 # Agree
		ai_chance = {
			factor = 100
		}

		prestige = 50

		FROM = {
			character_event = {
				id = kislev.2
				tooltip = EVTTOOLTIP_KISLEV_2
			}
		}
	}
	option = {
		name = EVTOPTB_KISLEV_1 # Refuse
		prestige = -50
		
		FROM = {
			character_event = {
				id = kislev.3
				tooltip = EVTTOOLTIP_KISLEV_3
			}
		}
	}
}

# Son or brother joins the Gryphon Legion
character_event = {
	id = kislev.2
	desc = EVTDESC_KISLEV_2
	picture = GFX_evt_kislev_lancers
	is_triggered_only = yes
	
	option = {
		name = EXCELLENT
		
		d_gryphon_legion = {
			holder_scope = {
				ROOT = {
					move_character = PREV
					if = {
						limit = { trait = in_hiding }
						remove_trait = in_hiding
						clr_character_flag = do_not_disturb
						add_character_modifier = {
							name = went_out_of_hiding_timer
							duration = 180
							hidden = yes
						}
						hidden_tooltip = { character_event = { id = CM.6400 } } # Notify plotters and family
					}
				}
			}
		}
	}
}

# Liege refuses request to join the Grypnon Legion
character_event = {
	id = kislev.3
	desc = EVTDESC_KISLEV_3
	picture = GFX_evt_kislev_lancers
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_KISLEV_3
		
		opinion = {
			who = FROM
			modifier = opinion_refused_request_mercenary
		}
	}
}

# On-action event: Kislev birth rituals if wise woman is present check for
# taint, birth Dzah ritual over flame (dispatch)
character_event = {
	id = kislev.4
	is_triggered_only = yes
	hide_window = yes

	trigger = {
		OR = { 
			father = { is_alive = yes }
			mother = { is_alive = yes }
		}
		is_alive = yes
	}

	immediate = {
		set_character_flag = event_grim
		if = {
			limit = {
				any_courtier = { has_minor_title = title_wise_woman }
				culture_group = kislevite_group
			}
			# Ping to wise woman
			random_courtier = {
				limit = { has_minor_title = title_wise_woman }
				character_event = { id = kislev.7 days = 7 random = 7 }
			}
		}
		else_if = {
			# Dazh ceremony
			limit = {
				liege = { culture_group = kislevite_group }
				OR = {
					religion = kislev_gods
					religion = northern_gods
				}
			}
			if = {
				limit = { mother = { is_married_matrilineally = yes  }}
				mother = { character_event = { id = kislev.5 days = 7 random = 7 }}
			}
			else = {
				father = { character_event = { id = kislev.5 days = 7 random = 7 }}
			}
		}
	}
}

# Kislev birth ritual, proceed with ritual
character_event = {
	id = kislev.5
	desc = EVTDESC_KISLEV_5
	picture = GFX_evt_kislev_town
	border = GFX_event_normal_frame_religion
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_KISLEV_5
		# Set the flag marking the outcome of ceremony
		FROM = {
			hidden_tooltip = { 
			random_list = {
				# Dazh gave protection
				95 = {
					set_character_flag = dazh_protection_granted
					modifier = {
						factor = 0.01
						has_chaos_taint_trigger = yes
					}
				}
				# Something is wrong
				5 = { 
					random_list = {
						50 =  {	set_character_flag = dazh_protection_tainted }
						50 = { set_character_flag = dazh_protection_death }
					}
				}
			}
			}
		}
		character_event = { id = kislev.6 }
	}
	option = {
		name = EVTOPTB_KISLEV_5
		piety = -100
		prestige = -50
	}
}
# Ceremony starts
character_event = {
	id = kislev.6
	border = GFX_event_normal_frame_religion
	picture = GFX_evt_birth
	desc = {
		text = EVTDESCA_KISLEV_6
		trigger = { FROMFROM = { has_character_flag = dazh_protection_granted }}
	}
	desc = {
		text = EVTDESCB_KISLEV_6
		trigger = { FROMFROM = { has_character_flag = dazh_protection_tainted }}
	}
	desc = {
		text = EVTDESCC_KISLEV_6
		trigger = { FROMFROM = { has_character_flag = dazh_protection_death }}
	}
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_KISLEV_6
		trigger = { FROMFROM = { has_character_flag = dazh_protection_granted }}
		piety = 10
	}
	option = {
		name = EVTOPTB_KISLEV_6
		trigger = { FROMFROM = { has_character_flag = dazh_protection_tainted }}
		FROMFROM = { piety = -50 }
		piety = -25
	}
	option = {
		name = EVTOPTC_KISLEV_6
		trigger = { FROMFROM = { has_character_flag = dazh_protection_death }}
		FROMFROM = { death = { death_reason = death_murder_unknown_combustion }}
		piety = -25
	}
	after = {
		FROMFROM = { 
			clr_character_flag = dazh_protection_death
			clr_character_flag = dazh_protection_granted
			clr_character_flag = dazh_protection_tainted
		}
	}
}

# Wise woman visits the child (AI)
character_event = {
	id = kislev.7
	hide_window = yes 
	is_triggered_only = yes
	
	immediate = {
		# Set the flag marking the outcome of ceremony
		FROM = { 
			save_event_target_as = chaos_tainted
			# more important parent decides
			if = {
				limit = { mother = { is_married_matrilineally = yes }}
					mother = { 
						character_event = { id = kislev.8 }
					}
			}
			else = {
				father = { character_event = { id = kislev.8 }}
			}
		}
	}
}

# Wise woman visits the child (parent)
character_event = {
	id = kislev.8
	desc = EVTDESCA_KISLEV_8
	picture = GFX_evt_kislev_town
	border = GFX_event_normal_frame_religion
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_KISLEV_8
		# Set the flag marking the outcome of ceremony
		character_event = { id = kislev.9 }
	}
}
# outcome 1: Child curse is pronounced
character_event = {
	id = kislev.9
	desc = {
		text = EVTDESCA_KISLEV_9
		trigger = { event_target:chaos_tainted = { has_chaos_taint_trigger = yes }}
	}
	desc = {
		text = EVTDESCB_KISLEV_9
		trigger = { event_target:chaos_tainted = { has_chaos_taint_trigger = no }}
	}
	picture = GFX_evt_birth
	border = GFX_event_normal_frame_religion
	is_triggered_only = yes
	
	# Select the curse
	immediate = {
		event_target:chaos_tainted = {
			if = {
				limit = { has_chaos_taint_trigger = yes }
			}
			# Select the child's curse
			else = {
				random_list = {
					10 = { set_character_flag = hag_curse_ring }
					10 = { set_character_flag = hag_curse_swear }
					10 = { set_character_flag = hag_curse_skin }
					10 = { set_character_flag = hag_curse_contradict }
					10 = { set_character_flag = hag_curse_clutch }
					10 = { set_character_flag = hag_curse_mountain }
					10 = { set_character_flag = hag_curse_horn }
					10 = { set_character_flag = hag_curse_dazh }
				}
			}
		}
	}
	# Child is tainted agree with Hag
	option = {
		trigger = { event_target:chaos_tainted = { has_chaos_taint_trigger = yes }}
		name = EVTOPTA_KISLEV_9
		custom_tooltip = {
			text = child_is_taken
			event_target:chaos_tainted = {
				hidden_tooltip = { death = { death_reason = death_missing }}
			}
		}
		ai_chance = {
			factor = 10
		}
	}
	# Child is not tainted
	option = {
		trigger = { event_target:chaos_tainted = { has_chaos_taint_trigger = no }}
		name = EVTOPTB_KISLEV_9
		ai_chance = {
			factor = 1
		}
	}
	# Child is tainted disagree with Hag
	option = {
		trigger = { event_target:chaos_tainted = { has_chaos_taint_trigger = yes }}
		name = EVTOPTC_KISLEV_9
		if = {
			limit = { liege = { culture = ungol }}
			piety = -50
			prestige = -25
		}
		# Hags kidnaps the kid
		hidden_tooltip = { 
			random_list = {
				60 = {
					modifier = {
						factor = 0.5
						FROMFROM = { NOT = { intrigue = 8 }}
					}
					modifier = {
						factor = 1.5
						FROMFROM = { intrigue = 12 }
					}
					modifier = {
						factor = 1.5
						FROMFROM = { intrigue = 16 }
					}
					character_event = { id = TOG.3258 days = 3 random = 3 }
				}
				40 = {
					modifier = {
						factor = 1.5
						FROMFROM = { intrigue = 12 }
					}
					modifier = {
						factor = 1.5
						FROMFROM = { intrigue = 16 }
					}
				}
			}
		}
		ai_chance = {
			factor = 5
			modifier = {
				factor = 0
				culture = ungol
			}
		}
	}
}
